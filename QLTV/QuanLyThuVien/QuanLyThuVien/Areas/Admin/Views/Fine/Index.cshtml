@using QuanLyThuVien.Models
@model IEnumerable<Fine>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Qu·∫£n l√Ω phi·∫øu ph·∫°t";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-xl mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h2 class="text-dark fw-bold">üí∞ Qu·∫£n l√Ω Phi·∫øu Ph·∫°t</h2>
        <div>
            <a asp-action="UnpaidFines" class="btn btn-warning rounded-pill px-4 fw-bold shadow-sm me-2">‚ö†Ô∏è Phi·∫øu Ch∆∞a Thanh To√°n</a>
            <a asp-action="Create" class="btn btn-danger rounded-pill px-4 fw-bold shadow-sm">‚ûï Th√™m Phi·∫øu Ph·∫°t</a>
        </div>
    </div>

    <div class="card shadow-lg mt-4 bg-white text-dark p-3">
        <div class="card-body">
            <div class="table-responsive w-100">
                <table id="finesTable" class="table table-hover w-100">
                    <thead class="table-primary">
                        <tr>
                            <th>M√£ phi·∫øu</th>
                            <th>M√£ m∆∞·ª£n</th>
                            <th>S√°ch</th>
                            <th>Ng∆∞·ªùi m∆∞·ª£n</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>H·∫°n thanh to√°n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th class="text-center">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-fine-id="@item.FineId" data-due-date="@item.DueDate.ToString("yyyy-MM-dd")">
                                <td>@item.FineId</td>
                                <td>@item.LoanId</td>
                                <td>@item.Loan?.Book?.Name</td>
                                <td>@item.Loan?.LibraryCard?.FullName</td>
                                <td>@item.Amount.ToString("N0") ƒë</td>
                                <td>@item.CreatedDate.ToString("dd/MM/yyyy")</td>
                                <td>@item.DueDate.ToString("dd/MM/yyyy")</td>
                                <td class="status-cell">
                                    @switch (item.Status)
                                    {
                                        case FineStatus.Pending:
                                            <span class="badge bg-warning rounded-pill">Ch·ªù thanh to√°n</span>
                                            break;
                                        case FineStatus.Paid:
                                            <span class="badge bg-success rounded-pill">ƒê√£ thanh to√°n</span>
                                            break;
                                        case FineStatus.Overdue:
                                            <span class="badge bg-danger rounded-pill">Qu√° h·∫°n</span>
                                            break;
                                    }
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <a asp-action="Edit" asp-route-id="@item.FineId" class="btn btn-warning btn-sm rounded-pill">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a asp-action="Details" asp-route-id="@item.FineId" class="btn btn-info btn-sm rounded-pill">
                                            <i class="fas fa-info-circle"></i>
                                        </a>
                                        @if (item.Status != FineStatus.Paid)
                                        {
                                            <form asp-action="MarkAsPaid" asp-route-id="@item.FineId" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <button type="submit" class="btn btn-success btn-sm rounded-pill" onclick="return confirm('X√°c nh·∫≠n ƒë√£ thanh to√°n phi·∫øu ph·∫°t n√†y?')">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </form>
                                        }
                                        <a asp-action="Delete" asp-route-id="@item.FineId" class="btn btn-danger btn-sm rounded-pill">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#finesTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Vietnamese.json"
                },
                "pageLength": 10,
                "ordering": true,
                "responsive": true,
                "dom": 'Bfrtip',
                "buttons": [
                    'copy', 'csv', 'excel', 'pdf', 'print'
                ]
            });

            // H√†m ki·ªÉm tra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i qu√° h·∫°n
            function checkOverdueStatus() {
                const now = new Date();
                const rows = document.querySelectorAll('#finesTable tbody tr');
                
                rows.forEach(row => {
                    const dueDate = new Date(row.dataset.dueDate);
                    const statusCell = row.querySelector('.status-cell');
                    const statusBadge = statusCell.querySelector('.badge');
                    
                    // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu phi·∫øu ch∆∞a thanh to√°n
                    if (statusBadge.classList.contains('bg-warning')) {
                        if (now > dueDate) {
                            // C·∫≠p nh·∫≠t giao di·ªán
                            statusBadge.className = 'badge bg-danger rounded-pill';
                            statusBadge.textContent = 'Qu√° h·∫°n';
                            
                            // G·ª≠i request c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n server
                            const fineId = row.dataset.fineId;
                            fetch(`/Admin/Fine/UpdateStatus/${fineId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                                }
                            });
                        }
                    }
                });
            }

            // Ki·ªÉm tra ngay khi trang load
            checkOverdueStatus();

            // Ki·ªÉm tra m·ªói ph√∫t
            setInterval(checkOverdueStatus, 60000);
        });
    </script>
}
